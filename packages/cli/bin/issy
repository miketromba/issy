#!/usr/bin/env node
import { readFileSync } from 'node:fs'
import { dirname, resolve } from 'node:path'
import { fileURLToPath } from 'node:url'
import updateNotifier from 'update-notifier'
import {
	detectPackageManager,
	isGlobalInstall,
	getUpdateCommand,
} from '../dist/update-checker.js'

const __dirname = dirname(fileURLToPath(import.meta.url))
const pkg = JSON.parse(
	readFileSync(resolve(__dirname, '..', 'package.json'), 'utf-8'),
)

const notifier = updateNotifier({ pkg, updateCheckInterval: 1000 * 60 })
if (notifier.update) {
	const scriptPath = fileURLToPath(import.meta.url)
	const pm = detectPackageManager(scriptPath)
	const isGlobal = isGlobalInstall(scriptPath)
	const updateCmd = getUpdateCommand(pm, isGlobal)
	notifier.notify({
		message: `Update available: ${notifier.update.current} â†’ ${notifier.update.latest}\nRun: ${updateCmd}`,
		defer: true,
		boxenOptions: {
			padding: 1,
			margin: 1,
			borderStyle: 'round',
			borderColor: 'yellow',
		},
	})
}

process.env.ISSY_PKG_VERSION = pkg.version
await import('../dist/main.js')
